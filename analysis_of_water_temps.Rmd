---
title: "watertemps"
author: "DJC"
date: "12/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analysis of water temperature time series



```{r packages}

library("mgcv")
library("gratia")
library("itsadug")
library("chron")
library("pammtools")
library("ggplot2")

```


```{r import_data}

#setwd("P:/Emory/Projects/Kenya Temperature/Data sets")
setwd("C:/Users/dcivite/Desktop/Trip docs 2/Temperature stuff/Data sets")
# This finds all of the files
#inputs = dir("P:/Emory/Projects/Kenya Temperature/Data sets", pattern=".csv")
inputs = dir("C:/Users/dcivite/Desktop/Trip docs 2/Temperature stuff/Data sets", pattern=".csv")

temp_set = list()

# This processes HOBOlogger data into a format usable for the analysis
for(i in 1:length(inputs)){
  temp_set[[i]] = read.csv(inputs[i], skip=1) # imports data set, skipping over HOBO-logger formatting
  temp_set[[i]] = cbind(temp_set[[i]], "Site" = inputs[i]) # Adds site name
  colnames(temp_set[[i]]) = c("obs", "time", "temp", "site")
  # Converts to a usable format
  temp_set[[i]][,"time"] = as.POSIXct(temp_set[[i]][,"time"], format="%m/%d/%Y %H:%M")
  # converts to days since 1/1/2019
  temp_set[[i]][,"days"] =as.numeric(julian(temp_set[[i]][,"time"], origin="0018-01-01 LMT"))
  temp_set[[i]][,"day_of_year"] = round(temp_set[[i]][,"days"] %% 365, digits=0)
  temp_set[[i]][,"hour"] = temp_set[[i]][,"days"] %% 1
}

temp_set[[1]]

```

```{r GAMMs}

### Individual data sets
m1 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[1]])
summary(m1)
draw(m1)

m2 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[2]])
summary(m2)
draw(m2)

m3 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[3]])
summary(m3)
draw(m3)

m4 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[4]])
summary(m4)
draw(m4)

m5 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[5]])
summary(m5)
draw(m5)

m6 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[6]])
summary(m6)
draw(m6)

m7 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[7]])
summary(m7)
draw(m7)

m8 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[8]])
summary(m8)
draw(m8)

m9 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[9]])
summary(m9)
draw(m9)

m10 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[10]])
summary(m10)
draw(m10)

m11 =gam(temp ~ te(hour, day_of_year, bs="cc", k=19), data=temp_set[[11]])
summary(m11)
draw(m11)

```

```{r}
# For now, trying to analyze several sites together
clean_sets = lapply(temp_set, subset, select = c("obs", "temp", "site", "hour", "day_of_year"))
many_sites = rbind(clean_sets[[2]], clean_sets[[3]], clean_sets[[4]], clean_sets[[5]], clean_sets[[7]],  clean_sets[[10]])
unique(many_sites$site)
many_sites$sites = as.factor(many_sites$site)

```

```{r}
many_sites$site = as.factor(many_sites$site)

m12 =bam(temp ~ site + te(hour, day_of_year, bs="cc", k=19), method="REML", data=many_sites) # Model G in the HGAM paper
summary(m12)
#draw(m12)
gg_tensor(x = m12, ci=FALSE)

m13 =bam(temp ~ site + te(hour, day_of_year, bs="cc", k=19)
                     + t2(hour, day_of_year, site, bs=c("cc", "cc", "re"), k=c(10, 10, 7), m=2, full=TRUE),
         method="REML",
         data=many_sites) # Model GS in the HGAM paper
summary(m13)
#draw(m13)
gg_tensor(x = m13, ci=FALSE)
draw(m13)

m14 =bam(temp ~ site + te(hour, day_of_year, bs="cc", k=19, m=2)
                     + te(hour, day_of_year, by=site, bs=c("cc", "cc"), k=c(10, 10), m=1),
         method="REML",
         data=many_sites) # Model GI in the HGAM paper
summary(m14)
gg_tensor(x = m14, ci=FALSE)
draw(m14)
gam.check(m14)

#bbmle::AICtab(m12, m13, 14) # model G is super stinky. Checking model GI vs model GS
AIC(m14) - AIC(m13) # model G is super stinky. Checking model GI vs model GS

# Make plot for obs vs. predicted temperature from all sites
p14 = predict.gam(m14, newdata=many_sites)
tail(p14)
dim(many_sites); length(p14)

pred.obs.df = data.frame(many_sites, "Predicted" = p14)
ggplot(data=pred.obs.df, aes(x=Predicted, y=temp)) + geom_point() + geom_abline() + 
 facet_grid(. ~ site)
```

```{r DTR}
# Visualize some diurnal temperature range data
head(many_sites)
maxx = aggregate(temp ~ site*day_of_year, FUN=max, data=many_sites)
head(maxx)
minn = aggregate(temp ~ site*day_of_year, FUN=min, data=many_sites)
head(minn)

DTR = data.frame(maxx, "min" = minn$temp, "DTR" = maxx$temp - minn$temp, drop=F)
head(DTR)
colnames(DTR)[3] = "max"

head(DTR)

ggplot(data=DTR, aes(x=day_of_year, y=DTR, group=site, colour=site)) + geom_line() + theme(legend.position = "none")

m_DTR = gamm(DTR ~ site + s(day_of_year, by=site, bs="cc"), correlation=corCAR1(form=~day_of_year|site), data=DTR)
summary(m_DTR$gam)
plot(m_DTR$gam)
```

